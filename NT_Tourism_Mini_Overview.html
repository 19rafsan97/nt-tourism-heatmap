<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NT Tourism — Mini Overview (5 Visuals)</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  :root{ --nt-ochre:#CC7722; --nt-red:#D32F2F; --nt-black:#111; --nt-white:#fff; --nt-sky:#E6F4FF; }
  html,body{margin:0;padding:0;background:var(--nt-sky);color:var(--nt-black);font-family:system-ui,Segoe UI,Inter,Arial}
  header{background:linear-gradient(90deg,var(--nt-ochre),#e2903d); color:#fff; padding:14px 18px; border-bottom:4px solid var(--nt-red)}
  h1{margin:0;font-size:1.25rem}
  .shell{max-width:1200px;margin:0 auto;padding:14px}
  .card{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.04);padding:12px}
  .row{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  @media (min-width: 980px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
  .controls{display:grid;gap:10px;grid-template-columns:repeat(5,minmax(140px,1fr));align-items:end}
  .controls label{font-size:.82rem;margin-bottom:6px;display:block;color:#333}
  .controls select,.controls input{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:10px;background:#fff}
  .btn{background:var(--nt-red);color:#fff;border:none;border-radius:10px;padding:9px 12px;font-weight:600;cursor:pointer}
  .kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
  .kpi{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px}
  .kpi .lab{font-size:.8rem;color:#555}
  .kpi .val{font-size:1.2rem;font-weight:700;color:var(--nt-red)}
</style>
</head>
<body>
<header><h1>NT Tourism — Mini Overview (5 Visuals)</h1></header>
<div class="shell">

  <div class="card">
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center">
      <div>
        <input type="file" id="fileInput" accept=".json,application/json"/>
      </div>
      <div class="controls">
        <div>
          <label>Sentiment</label>
          <select id="sentSel" multiple size="3">
            <option value="positive" selected>positive</option>
            <option value="neutral" selected>neutral</option>
            <option value="negative" selected>negative</option>
          </select>
        </div>
        <div>
          <label>Min Rating</label>
          <input id="minRating" type="number" min="1" max="5" step="1" value="1"/>
        </div>
        <div>
          <label>Max Places</label>
          <input id="maxPlaces" type="number" min="5" max="30" step="1" value="10"/>
        </div>
        <div>
          <label>Date Min (YYYY-MM-DD)</label>
          <input id="dateMin" type="text" placeholder="auto"/>
        </div>
        <div>
          <label>Date Max (YYYY-MM-DD)</label>
          <input id="dateMax" type="text" placeholder="auto"/>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="applyBtn">Apply</button>
        <button class="btn" style="background:#444" id="resetBtn">Reset</button>
      </div>
    </div>
  </div>

  <div class="kpis" style="margin-top:12px">
    <div class="kpi"><div class="lab">Reviews</div><div class="val" id="kpi_rev">—</div></div>
    <div class="kpi"><div class="lab">Places</div><div class="val" id="kpi_plc">—</div></div>
    <div class="kpi"><div class="lab">Avg Rating</div><div class="val" id="kpi_rate">—</div></div>
    <div class="kpi"><div class="lab">Avg THI</div><div class="val" id="kpi_thi">—</div></div>
  </div>

  <div class="row cols-2">
    <div class="card"><div id="v1" style="height:420px"></div></div>
    <div class="card"><div id="v2" style="height:420px"></div></div>
  </div>
  <div class="row cols-3">
    <div class="card"><div id="v3" style="height:360px"></div></div>
    <div class="card"><div id="v4" style="height:360px"></div></div>
    <div class="card"><div id="v5" style="height:360px"></div></div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
const C = { ochre:'#CC7722', red:'#D32F2F', sky:'#E6F4FF', black:'#111', white:'#fff' };

function parseDate(d){
  if(!d) return null;
  if(/^\\d{2}-\\d{2}-\\d{4}$/.test(d)){ const [dd,mm,yy]=d.split('-').map(Number); return new Date(yy,mm-1,dd); }
  const t = Date.parse(d); return isNaN(t)? null : new Date(t);
}
function clamp(n,lo,hi){ return Math.max(lo, Math.min(hi,n)); }
function mean(a){ return a.length? a.reduce((x,y)=>x+y,0)/a.length : 0; }
function monthKey(dt){ return dt? dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0') : null; }

function enrich(rows){
  return rows.map(r=>{
    const rating = Number(r.rating||0);
    let s = typeof r.sentiment_score==='number'? r.sentiment_score : (parseFloat(r.sentiment_score)||0);
    if(s<0 || s>1){ s = (s+1)/2; } // normalize -1..1 to 0..1
    const rs = clamp((rating-1)/4,0,1);
    const thi = 0.5*rs + 0.5*s; // 0..1
    return {...r, rating, sentiment_score:s, thi, review_dt: parseDate(r.review_date), month: monthKey(parseDate(r.review_date))};
  });
}

function groupByPlace(rows){
  const m = new Map();
  rows.forEach(r=>{
    const k = r.place_id || r.place_name || 'unknown';
    if(!m.has(k)){ m.set(k, {key:k, place_name:r.place_name||'Unknown', lat:r.lat, lng:r.lng, n:0, ratings:[], thi:[]}); }
    const o = m.get(k); o.n++; o.ratings.push(r.rating); o.thi.push(r.thi);
  });
  return Array.from(m.values()).map(o=>({ ...o, avg_rating: mean(o.ratings), avg_thi: mean(o.thi)}));
}

function applyAll(){
  const sentiments = Array.from(document.getElementById('sentSel').selectedOptions).map(o=>o.value);
  const minRating = Number(document.getElementById('minRating').value||1);
  const maxPlaces = Number(document.getElementById('maxPlaces').value||10);
  const dmin = document.getElementById('dateMin').value.trim();
  const dmax = document.getElementById('dateMax').value.trim();

  const rows = DATA.filter(r=>{
    const okS = !r.sentiment || sentiments.includes(String(r.sentiment).toLowerCase());
    const okR = r.rating >= minRating;
    const okD = (!dmin || (r.review_dt && r.review_dt >= new Date(dmin))) && (!dmax || (r.review_dt && r.review_dt <= new Date(dmax)));
    return okS && okR && okD;
  });

  drawKPIs(rows);
  v1_map(rows, maxPlaces);
  v2_topPlaces(rows, maxPlaces);
  v3_thi(rows, maxPlaces);
  v4_sentTrend(rows);
  v5_ratings(rows);
}

/* ===== Visuals ===== */
function drawKPIs(rows){
  const places = groupByPlace(rows);
  document.getElementById('kpi_rev').innerText = rows.length;
  document.getElementById('kpi_plc').innerText = places.length;
  document.getElementById('kpi_rate').innerText = mean(rows.map(r=>r.rating)).toFixed(2);
  document.getElementById('kpi_thi').innerText = (mean(rows.map(r=>r.thi))*100).toFixed(0);
}

// V1: Map (aggregated bubbles, no labels to avoid overlap)
function v1_map(rows, maxPlaces){
  const places = groupByPlace(rows).sort((a,b)=>b.n-a.n).slice(0,maxPlaces);
  const trace = {
    type:'scattergeo', mode:'markers',
    lat: places.map(p=>p.lat), lon: places.map(p=>p.lng),
    marker:{ size: places.map(p=> Math.max(8, Math.min(26, 6 + p.n))), color: C.red, line:{color:'#222', width:1}, opacity:.85 },
    hovertemplate:'<b>%{customdata[0]}</b><br>Reviews: %{customdata[1]}<br>Avg THI: %{customdata[2]:.0f}<extra></extra>',
    customdata: places.map(p=>[p.place_name, p.n, p.avg_thi*100])
  };
  const lats = places.map(p=>p.lat), lngs=places.map(p=>p.lng);
  const latC = lats.length? lats.reduce((a,b)=>a+b,0)/lats.length : -19.5;
  const lonC = lngs.length? lngs.reduce((a,b)=>a+b,0)/lngs.length : 133.8;
  const layout = {
    title:{text:'Map — Top Places (bubble size = volume)', font:{color:C.red}},
    paper_bgcolor:C.sky, plot_bgcolor:C.sky, margin:{t:40,l:0,r:0,b:0},
    geo:{ showland:true, landcolor:'#f4d7bd', showocean:true, oceancolor:C.sky, projection:{type:'equirectangular'}, center:{lat:latC, lon:lonC} }
  };
  Plotly.newPlot('v1',[trace],layout,{responsive:true,displaylogo:false});
}

// V2: Top places by reviews (bar)
function v2_topPlaces(rows, maxPlaces){
  const places = groupByPlace(rows).sort((a,b)=>b.n-a.n).slice(0, maxPlaces);
  const trace = { type:'bar', x: places.map(p=>p.place_name), y: places.map(p=>p.n), marker:{color:C.ochre, line:{color:'#222', width:1}} };
  const layout = { title:{text:'Top Places by Reviews',font:{color:C.red}}, xaxis:{tickangle:-30}, yaxis:{title:'Reviews'}, paper_bgcolor:C.sky, plot_bgcolor:'#fff', margin:{t:40,b:90,l:50,r:10} };
  Plotly.newPlot('v2',[trace],layout,{responsive:true,displaylogo:false});
}

// V3: Avg THI (Top places)
function v3_thi(rows, maxPlaces){
  const places = groupByPlace(rows).sort((a,b)=>b.n-a.n).slice(0, maxPlaces);
  const trace = { type:'bar', x: places.map(p=>p.place_name), y: places.map(p=> Math.round(p.avg_thi*100)), marker:{color:C.red} };
  const layout = { title:{text:'Average THI (Top Places)',font:{color:C.red}}, xaxis:{tickangle:-30}, yaxis:{title:'THI (0–100)'}, paper_bgcolor:C.sky, plot_bgcolor:'#fff', margin:{t:40,b:90,l:50,r:10} };
  Plotly.newPlot('v3',[trace],layout,{responsive:true,displaylogo:false});
}

// V4: Monthly sentiment trend
function v4_sentTrend(rows){
  const m = new Map();
  rows.filter(r=>r.month).forEach(r=>{
    if(!m.has(r.month)) m.set(r.month, []);
    m.get(r.month).push(r.sentiment_score);
  });
  const xs = Array.from(m.keys()).sort();
  const ys = xs.map(x=> mean(m.get(x)));
  const trace = { type:'scatter', mode:'lines+markers', x: xs, y: ys, line:{color:C.red,width:3}, marker:{color:C.red,size:6} };
  const layout = { title:{text:'Monthly Sentiment (avg)',font:{color:C.red}}, yaxis:{range:[0,1], tickformat:'.2f'}, paper_bgcolor:C.sky, plot_bgcolor:'#fff', margin:{t:40,l:50,r:10,b:50} };
  Plotly.newPlot('v4',[trace],layout,{responsive:true,displaylogo:false});
}

// V5: Ratings distribution
function v5_ratings(rows){
  const trace = { type:'histogram', x: rows.map(r=>r.rating), nbinsx:5, marker:{color:C.ochre, line:{color:'#222', width:1}} };
  const layout = { title:{text:'Ratings Distribution',font:{color:C.red}}, xaxis:{dtick:1,title:'Rating'}, yaxis:{title:'Count'}, paper_bgcolor:C.sky, plot_bgcolor:'#fff', margin:{t:40,l:50,r:10,b:50} };
  Plotly.newPlot('v5',[trace],layout,{responsive:true,displaylogo:false});
}

/* ===== App state ===== */
let RAW=[], DATA=[];
document.getElementById('applyBtn').addEventListener('click', applyAll);
document.getElementById('resetBtn').addEventListener('click', ()=>{
  Array.from(document.getElementById('sentSel').options).forEach(o=>o.selected=true);
  document.getElementById('minRating').value=1;
  document.getElementById('maxPlaces').value=10;
  document.getElementById('dateMin').value='';
  document.getElementById('dateMax').value='';
  if(DATA.length) applyAll();
});

document.getElementById('fileInput').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  try{
    const txt = await f.text();
    const js = JSON.parse(txt);
    RAW = Array.isArray(js)? js : (js.data || []);
    if(!Array.isArray(RAW)) throw new Error("Expected JSON array or {data:[]}.");
    DATA = enrich(RAW);
    const dts = DATA.map(r=>r.review_dt).filter(Boolean).sort((a,b)=>a-b);
    if(dts.length){
      document.getElementById('dateMin').value = dts[0].toISOString().slice(0,10);
      document.getElementById('dateMax').value = dts[dts.length-1].toISOString().slice(0,10);
    }
    applyAll();
  }catch(e){
    alert("Failed to parse JSON: "+e.message);
  }
});
</script>
</body>
</html>
